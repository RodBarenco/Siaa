# =============================================================
# SIAA ‚Äî Docker Compose
# Target: Oracle Cloud Free Tier ‚Äî ARM64 Ampere A1
# Servi√ßos: ollama, siaa, siaa-vault, siaa-proxy
# =============================================================
services:

  # -----------------------------------------------------------
  # 1. OLLAMA ‚Äî LLM local
  # -----------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: siaa-ollama
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    deploy:
      resources:
        limits:
          cpus: "3.0"
          memory: 12G
        reservations:
          memory: 2G

  # -----------------------------------------------------------
  # 2. OLLAMA-INIT ‚Äî Pull autom√°tico do modelo
  # -----------------------------------------------------------
  ollama-init:
    image: curlimages/curl:latest
    container_name: siaa-ollama-init
    depends_on:
      - ollama
    env_file:
      - .env
    entrypoint: ["sh", "-c"]
    command:
      - |
        echo "‚è≥ Aguardando Ollama..."
        sleep 10
        echo "üì¶ Baixando modelo: $${OLLAMA_MODEL_CHAT:-granite3.3:2b}..."
        curl -X POST http://ollama:11434/api/pull \
          -d "{\"name\": \"$${OLLAMA_MODEL_CHAT:-granite3.3:2b}\"}"
        echo "‚úÖ Modelo pronto!"

  # -----------------------------------------------------------
  # 3. SIAA-VAULT ‚Äî Cofre de dados sens√≠veis dos m√≥dulos
  # -----------------------------------------------------------
  siaa-vault:
    build:
      context: .
      dockerfile: src/siaa_vault/Dockerfile
    container_name: siaa-vault
    restart: unless-stopped
    ports:
      - "8002:8002"
    env_file:
      - .env
    environment:
      VAULT_DATA_DIR: /vault-data
    volumes:
      - vault-data:/vault-data
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # -----------------------------------------------------------
  # 4. SIAA-PROXY ‚Äî Proxy para servi√ßos externos
  # -----------------------------------------------------------
  siaa-proxy:
    build:
      context: .
      dockerfile: src/siaa_proxy/Dockerfile
    container_name: siaa-proxy
    restart: unless-stopped
    ports:
      - "8001:8001"
    env_file:
      - .env
    volumes:
      - proxy-data:/proxy-data
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # -----------------------------------------------------------
  # 5. SIAA ‚Äî Bot principal
  # restart: unless-stopped garante que o bot vai tentar
  # reconectar ao ollama at√© ele estar pronto.
  # -----------------------------------------------------------
  siaa:
    build:
      context: .
      dockerfile: src/siaa/Dockerfile
    container_name: siaa-bot
    restart: unless-stopped
    depends_on:
      - ollama
      - siaa-vault
      - siaa-proxy
    env_file:
      - .env
    environment:
      FORCE_TRAIN: "true"
      SIAA_DATA_DIR: /siaa-data
      OLLAMA_URL: http://siaa-ollama:11434
      PROXY_SERVER_URL: http://siaa-proxy:8001
      VAULT_SERVER_URL: http://siaa-vault:8002
      PYTHONUNBUFFERED: "1"
    volumes:
      - siaa-data:/siaa-data
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 10G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

# =============================================================
# VOLUMES
# =============================================================
volumes:
  siaa-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/siaa-data

  ollama-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/ollama-data

  proxy-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/proxy-data

  vault-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/vault-data